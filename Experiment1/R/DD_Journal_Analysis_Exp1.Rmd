---
title: 'Experiment 1: Drag-and-drop Analysis for Journal Paper'
author: 'Burcu Arslan'
output:
  html_document:
    df_print: paged
---

This is an [R Markdown] Notebook that analyzes of Experiment 1 (MTurk). 
In this experiment, there are 10 math items. Each item has 5 sources and 3 targets (except in Swapped Content condition). 

* There are 5 experimental conditions: 
1. Sources First, 
2. Targets First (in the original data Condition 3), 
3. Swapped Content (in the original data Condition 4), 
4. No Problem Statement (in the original data Condition 5), 
5. Multiple Comparison Numbers (in the original data Condition 2).

##Files

* merged_exp_1_v3_fred.csv file is generated by Fred Yan based on the log files.

* DD_Exp1_Sequence_Strategy_pretest_01182019.csv file (strategies) is generated by Yang and modified by Tao based on the merged_exp_1_v3_fred.csv. 

* Exp1_D_D_Scores.csv file is based on C4 data provided by Pavan.

* Exp1_demographics.csv file is based on MTurk data provided by Heather.

```{r Setup, eval=TRUE, echo=FALSE}
# load libraries
library(psych); library(car); library(pastecs); library(ggplot2); library(scales); library(plotly)
library(Rmisc); library(GGally);  library(plotrix); library(MASS); library(stringr); library(Hmisc)
library(gtools); library(dplyr); library(reshape); library('descr');
library(lme4);  ## linear mixed effect models
library(lmerTest);  ## to get p values for lmer
library(reshape2); ## to convert from wide to long data format
library(plyr); ## adding means
library(dplyr);
library(ordinal);library(sjPlot);library(ggridges)

# centering with 'scale()'

# set current working directory. 
# the current working directory should include folder merge storing merged data 
# for the extraction and analysis of process data
knitr::opts_knit$set(root.dir = "/Users/barslan/Documents/Github/Drag_and_Drop/Experiment1/R")

source('General_Functions.R') # incorporate general functions

##below code is to compile the notebook instead of using knit button
#source("General_Functions.R")
#library(knitr)
#rmarkdown::render('DD_Journal_Analysis_Exp1.Rmd')
```

# Read and analyze extracted process data

```{r Read files and manipulate, eval=TRUE, echo=FALSE}
# read back data files
seq_5act<-read.csv('DD_Exp1_Sequence_Strategy_pretest_01182019.csv')  ## some of the timespentonItems were changed manually based on Fred's data

##Change conditions names for the clarity of the paper as follows (i.e., the updated condition names are in line with the description text at the beginning of this notebook:


seq_5act$Condition[seq_5act$Condition == 1]<-"Control"
seq_5act$Condition[seq_5act$Condition == 2]<-"Modified Problem Statement"
seq_5act$Condition[seq_5act$Condition == 3]<-"Targets First"
seq_5act$Condition[seq_5act$Condition == 4]<-"Swapped Content"
seq_5act$Condition[seq_5act$Condition == 5]<-"No Problem Statement"

seq_5act$Condition<-as.factor(seq_5act$Condition)
seq_5act$item<-as.factor(seq_5act$item)



seq_5act$Condition <- factor(seq_5act$Condition, levels = c("Control", "Targets First", "Swapped Content","No Problem Statement", "Modified Problem Statement"))

merged_log <- read.csv("merged_exp_1_v3_fred.csv", header = TRUE)  ## there were some mistakes in the log file of Fred in terms of fillings and timings. I compared the differences between log timestamps and C4 timestamps manually and corrected manually

## repeat the condition recoding
merged_log$Condition[merged_log$Condition == 1]<-"Control"
merged_log$Condition[merged_log$Condition == 2]<-"Modified Problem Statement"
merged_log$Condition[merged_log$Condition == 3]<-"Targets First"
merged_log$Condition[merged_log$Condition == 4]<-"Swapped Content"
merged_log$Condition[merged_log$Condition == 5]<-"No Problem Statement"

merged_log$Condition<-as.factor(merged_log$Condition)

merged_log$Condition <- factor(merged_log$Condition, levels = c("Control", "Targets First", "Swapped Content","No Problem Statement", "Modified Problem Statement"))

str(merged_log)
#also, the problematic ids are shown below and corrected manually
#there were couple of problems in the log files
#in A31866VW2GR5J 1c and ASX1CKKF6OXL1 1e, A2WTWBGW31UAN 1c, A3QUIF68PT71S 1c, also more in fredyan_C4 mismatches.csv I corrected them manually. So, let's read the file again.

#format(merged_log$timestamp, scientific = FALSE)
### fill DDSSMC
#library(zoo)
#merged_log$item_id <- gsub('\\s+', '', merged_log$item_id )  # replace multiple spaces by blanks
#merged_log$item_id [merged_log$item_id == ''] <- NA  # replace blanks by NAs
#merged_log$item_id  <- na.locf(merged_log$item_id)

### subset only d&d items

##note than there is a mistake in DDSSMC_x columns' fill. item-loaded events for the first dd items filled as SSMC and the first post-test items are filled as DD
## so I will use the item_id columns to subset DD items
merged_log_dd <- subset(merged_log, item_id == "1a" | item_id == "1b" | item_id == "1c" | item_id == "1d" | item_id == "1e"
                        | item_id == "2a" | item_id == "2b" | item_id == "2c" | item_id == "2d" | item_id == "2e"
                        | item_id == "3a" | item_id == "3b" | item_id == "3c" | item_id == "3d" | item_id == "3e"
                        | item_id == "4a" | item_id == "4b" | item_id == "4c" | item_id == "4d" | item_id == "4e"
                        | item_id == "5a" | item_id == "5b" | item_id == "5c" | item_id == "5d" | item_id == "5e"
                        | item_id == "6a" | item_id == "6b" | item_id == "6c" | item_id == "6d" | item_id == "6e"
                        | item_id == "7a" | item_id == "7b" | item_id == "7c" | item_id == "7d" | item_id == "7e"
                        | item_id == "8a" | item_id == "8b" | item_id == "8c" | item_id == "8d" | item_id == "8e"
                        | item_id == "9a" | item_id == "9b" | item_id == "9c" | item_id == "9d" | item_id == "9e"
                        | item_id == "10a" | item_id == "10b" | item_id == "10c" | item_id == "10d" | item_id == "10e")

merged_log_dd <- subset(merged_log_dd, eventType == "item")
merged_log_dd$item_id<- as.character(merged_log_dd$item_id)
merged_log_dd$item <- substr(merged_log_dd$item_id, 1, nchar(merged_log_dd$item_id)-1)
merged_log_dd$item <- as.factor(merged_log_dd$item)

### get only IDs that we included in our seq_5act df

merged_log_dd_reducedIDs<-subset(merged_log_dd, ID %in% seq_5act$ID)

#merged_log_dd_reducedIDs<-merged_log_dd[match(seq_5act$ID, merged_log_dd$ID), ]

merged_log_dd_reducedIDs$ID<-droplevels(merged_log_dd_reducedIDs$ID)

#write.csv(merged_log_dd_reducedIDs, "merged_Exp1_v3_fred_onlydd.csv")  


write.csv(merged_log_dd_reducedIDs,"merged_log_dd_reducedIDs.csv")


##first exclude Source and Target Focus strategy from strategy column, we only use seq-5act_strategy df for the strategy related analysis.
##For the general condition comparisons, we use seq_5act df. The reason is that we do not want to lose data by excluding participants who
## used Source and Target Focus strategy when the RQ is not related to strategies (i.e., score, time spent on item, pauses)

seq_5act_strategy<-subset(seq_5act, strategy != "Source and Target Focus")

seq_5act_strategy$new_strategy <- factor(seq_5act_strategy$new_strategy, levels = c("Source Focus", "Target Focus", "Other"), 
                            labels = c("Source-focused", "Target-focused", "Mixed Approach"))

seq_5act_strategy$Condition<-as.factor(seq_5act_strategy$Condition)
seq_5act_strategy$item<-as.factor(seq_5act_strategy$item)

### add itemtime from fred's df to Yang's seq_act5 df
seq_5act_fredtime<-merge(seq_5act, merged_log_dd_reducedIDs[, c("ID", "item_id","itemtime")], by = c("ID", "item_id")) 
seq_5act_fredtime_<-unique(seq_5act_fredtime)
write.csv(seq_5act_fredtime_, "seq_5act_fredtime_.csv")


### add itemtime from fred's df to Yang's seq_act5 df  ### below the file excludes "source and target focus" strategy
seq_5act_fredtime_strategy<-merge(seq_5act_strategy, merged_log_dd_reducedIDs[, c("ID", "item_id","itemtime")], by = c("ID", "item_id")) 
seq_5act_fredtime_strategy<-unique(seq_5act_fredtime_strategy)

```
# Figure 6. Predicted probabilities (marginal effects) for scores in each condition.

```{r Scores by condition}

###plot_model figure does not follow factor level order for some reason. I will use a modfied data for lmer
forlmer<-read.csv('DD_Exp1_Sequence_Strategy_pretest_01182019.csv')
forlmer$Condition[forlmer$Condition == 1]<-1
forlmer$Condition[forlmer$Condition == 2]<-6
forlmer$Condition[forlmer$Condition == 3]<-2
forlmer$Condition[forlmer$Condition == 4]<-3
forlmer$Condition[forlmer$Condition == 5]<-4
forlmer$Condition[forlmer$Condition == 6]<-5
forlmer$Condition<-as.factor(forlmer$Condition)
forlmer$item<-as.factor(forlmer$item)

forlmer$Condition<-factor(forlmer$Condition, levels=c("1", "2", "3","4", "5"),
                          labels= c("1.Control", "2.Targets First", "3.Swapped Content","4.No Problem Statement", "5.Modified Problem Statement"))
levels(forlmer$Condition) <- gsub(" ", "\n", levels(forlmer$Condition))
center_scale <- function(x) {
    scale(x, scale = FALSE)
}

lmer4a<-glmer(ItemFinalScoreBinary ~  center_scale(pretest_final_score_total)+ Condition + (1|ID)+ (1|item), data =forlmer, family = binomial, control = glmerControl(optimizer = "bobyqa"))
summary(lmer4a)


##plotting corrrelation matrix of fixed effects

require(sjPlot)

#plot_model(lmer4a,show.values = TRUE, value.offset = .3)
#the predicted values are based on the fixed effects intercept's estimate 
#and each specific fixed term's estimate. 
#All other fixed effects are set to zero (i.e. ignored), which corresponds to family(fit)$linkinv(eta = b0 + bi * xi) 
#(where xi is the estimate of fixed effects and b0 is the intercept of the fixed effects; the inverse link-function is used). 
#This plot type may give similar results as type = "pred", however, type = "fe.slope" does not adjust for other predictors.

Gplot_predicted_score<-plot_model(lmer4a, type="eff", terms = "Condition")
Gplot_predicted_score
#' get the y-axis ranges actually used in the graph
my.ggp.yrange <- ggplot_build(Gplot_predicted_score)$data
score<-Gplot_predicted_score+labs(title="", 
                           x="Condition", y="Predicted Probabilities for Score", size=geom.text.size) +
    theme_bw() +
    theme(plot.title=element_text(size=theme.size, face="bold"), axis.title=element_text(size=theme.size, face="bold"), 
          axis.text.x=element_text(size=theme.size), axis.text.y=element_text(size=theme.size),
          legend.text=element_text(size=theme.size), legend.title=element_text(size=theme.size, face="bold"))

score  

fileName <- ("predicted_score")
savefig(fileName, 300, 12, 8, "in", "png")
```

## Time spent by Condition
```{r Time spent by condition}
## as factors

seq_5act_fredtime_$ID<-factor(seq_5act_fredtime_$ID)
seq_5act_fredtime_$item<-factor(seq_5act_fredtime_$item)
seq_5act_fredtime_$Condition<-factor(seq_5act_fredtime_$Condition)

seq_5act_fredtime_$logTime<-log(seq_5act_fredtime_$itemtime)

boxplot(seq_5act_fredtime_$itemtime, horizontal = T)

### remove outliers

seq_5act_wo_outliers <- seq_5act_fredtime_[seq_5act_fredtime_$itemtime > quantile(seq_5act_fredtime_$itemtime, .25) - 1.5*IQR(seq_5act_fredtime_$itemtime) & 
                                              seq_5act_fredtime_$itemtime < quantile(seq_5act_fredtime_$itemtime, .75) + 1.5*IQR(seq_5act_fredtime_$itemtime), ] #rows

seq_5act_wo_outliers_strategy <- seq_5act_fredtime_strategy[seq_5act_fredtime_strategy$itemtime > quantile(seq_5act_fredtime_strategy$itemtime, .25) - 1.5*IQR(seq_5act_fredtime_strategy$itemtime) & 
                                                                seq_5act_fredtime_strategy$itemtime < quantile(seq_5act_fredtime_strategy$itemtime, .75) + 1.5*IQR(seq_5act_fredtime_strategy$itemtime), ] #rows

lmer1<-lmer(logTime ~ n_DD_event_new + Condition + (1|ID) + (1|item) , data =seq_5act_wo_outliers)
summary(lmer1)

## plotting model results

Gplot_predicted_gap1<-plot_model(lmer1, type="eff", terms = c("n_DD_event_new", "Condition"))

#' get they-axis ranges actually used in the graph
my.ggp.yrange <- ggplot_build(Gplot_predicted_gap1)$data

Gplot_predicted_gap1+labs(title="", 
                         x="Number of actions", y="Predicted log(time)") +
    theme_bw()+ xlim(3,17)+
    theme(plot.title=element_text(size=16, face="bold"),axis.title=element_text(size=16), 
          axis.text.x=element_text(size=14), axis.text.y=element_text(size=14))

```

## Figure 7. Percentage of response strategies in each experimental condition.

```{r Strategy by condition}
##crosstab percentage
strategy_byCondition_pct_new <- crosstab(seq_5act_strategy, row.vars = c("Condition"), col.vars = "new_strategy", type = "r", addmargins = FALSE)
write.csv(strategy_byCondition_pct_new$crosstab, 'DD_Exp1_Strategy_byCondition_pct_01162019.csv', row.names=FALSE)
strategy_byCondition_pct_new <- read.csv('DD_Exp1_Strategy_byCondition_pct_01162019.csv')
strategy_byCondition_pct_new$Condition <- c("1.Control","2.Targets First","3.Swapped Content","4.No Problem Statement","5.Modified Problem Statement")
strategy_byCondition_pct_new$Condition<-as.factor(strategy_byCondition_pct_new$Condition)
## reorder the levels
#strategy_byCondition_pct_new$Condition <- factor(strategy_byCondition_pct_new$Condition, levels = c("Control","Targets First","Swapped Content","No Problem Statement","Modified Problem Statement")) 
                                                     
strategy_byCondition_pct_new_long<-melt(strategy_byCondition_pct_new,id=c("Condition"))
names(strategy_byCondition_pct_new_long)[2]<-"Strategy"
names(strategy_byCondition_pct_new_long)[3]<-"Percentage"

strategy_byCondition_pct_new_long$Strategy <- factor(strategy_byCondition_pct_new_long$Strategy, levels = c("Source.focused", "Target.focused", "Mixed.Approach"), 
                                                     labels = c("Source-focused", "Target-focused", "Mixed Approach"))

# to show levels in two separate lines
levels(strategy_byCondition_pct_new_long$Condition) <- gsub(" ", "\n", levels(strategy_byCondition_pct_new_long$Condition))


# stacked bar plot


stackbar<-ggplot(strategy_byCondition_pct_new_long, aes(x=Condition, y=Percentage, fill=Strategy)) + geom_bar(position = position_stack(),stat = "identity", width = .7) +
    labs(title="",
         x="Condition", y="Percentage of Strategies", size=geom.text.size) + 
    theme_bw() + 
    theme(plot.title=element_text(size=theme.size), axis.title=element_text(size=theme.size, face="bold"), 
          axis.text.x=element_text(size=theme.size), axis.text.y=element_text(size=theme.size),
          legend.text=element_text(size=theme.size), legend.title=element_text(size=theme.size, face="bold")) + #scale_y_continuous(labels = percent_format()) +
    scale_fill_discrete(name = "Strategy") + 
    geom_text(aes(label = round(Percentage, digits =1)), position = position_stack(vjust = 0.5), size = 5)

stackbar
fileName <- ("strategy_byCondition_stackbar")
savefig(fileName, 300, 12, 8, "in", "png")
```